# Структура плана запроса

## Стадии {#stages}

Давайте выполним чуть более сложный запрос и посмотрим, как это будет выглядеть в графическом представлении

```sql
SELECT count(*) cnt, l_orderkey, sum(l_quantity)
  FROM lineitem
  WHERE l_commitdate >= date("1993-01-01") and l_commitdate < date("1993-02-01")
  GROUP BY l_orderkey
  HAVING sum(l_quantity) > 200
  ORDER BY cnt DESC, l_orderkey
```

![Простая агрегация](../../_assets/rts-structure-1.svg)

Здесь показан структура графа вычислений, который получился в результате компиляции этого запроса. При компиляции запрос структурно разбивается на логические операторы. Для каждого логического оператора создаётся один или несколько физических операторов, которые объединятся в стадии выполнения запроса.

Стадия - это неделимая программа, однако из-за распределенной массивно-параллельной природы {{ ydb-short-name }} стадия может содержать более 1 задачи, которые работают параллельно, возможно на разных узлах. Поток данных передаётся от стадии к стадии и в общем случае образует DAG, но пока что у нас более простой случай, все стадии работют последовательно. Поток данных идёт снизу вверх, на нижнем уровне находится хранилище данных, сверху - результат выполнения запроса.

На графе отображаются стадии двух типов

1. Часть которая выполняется непосредственно в системе хранения (колоночные таблицы или шарды) выделяется более тёмным цветом
2. Часть, которая не хранит, а только обрабатывает данные (компьют) выделяется более светлым цветом, а также нумеруется последовательно, начиная с ```0```.

В приведённом примере у нас есть три вычислительные стадии ```0```, ```1``` и ```2```, а также стадия, связанная с таблицей ```lineitem``` (такие стадии не нумеруются). Кроме того, любая стадия может быть временно выделено для удобства исследования. В приведённом примере выделена стадия ```1```. Если это вдруг не так, обновите страницу, вероятно вы уже сменили выбранный элемент. Перезагрузка страницы приведёт изображения в исходное состояние.

{% note tip %}
Попробуйте прямо сейчас изменить выбранную стадию, это удобно и полезно при работе с гораздо более сложными планами, состоящими из большого количества стадий.
{% endnote %}

Если кратко описать, что происходит на этом плане, то получится следующее (напоминаем, что список на этой странице идёт сверху вниз, но данные на графике, а также операторы и стадии расположены в обратном порядке и сопоставлять этот перечень следует начиная с самом низа графика):

1. Таблица ```lineitem``` полностью сканируется (перебираются все строки), потому что условие ```WHERE``` не использует первичный ключ данной таблицы
2. Данные фильтруются по условия относительно поля ```l_commitdate```, это происходит непосредственно в месте хранения (пушдаун предиката) для экономии объема передаваемых данных
3. В стадии ```0``` выполняется предварительная агрегация данных с группировкой по полю ```l_orderkey``` (как это и указано в части ```GROUP BY```)
4. Далее данные перераспределяются (шаффл) в стадию ```1```, подробнее это обсуждается в следующем разделе
5. В стадии ```1``` выполняется финальная агрегация данных, дополнительная фильтрация (согласно условию ```HAVING```) и локальная сортировка
6. Последняя стадия ```2``` объединяет отсортированные потоки данных в одну глобально отсортированную последовательность, которая и возвращается в качестве результата

{% note tip %}
Если непонятно, что означает тот или иной графический элемент, спозиционируйте над ним указатель мыши. Большинство элементов имеют соответствующие подсказки с дополнительными пояснениями или уточнениями, которые будут показаны во всплывающем окне. Это не заменит детальное описание принятых символом и условностей, которые вы найдёте далее по тексту, то тоже поможет и сейчас, и в будущем.
{% endnote %}

## Каналы связи {#connections}

![Каналы связи](../../_assets/rts-structure-2.svg)
